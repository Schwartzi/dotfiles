;*******************************************************************
;* This stationery serves as the framework for a user application. *
;* For a more comprehensive program that demonstrates the more     *
;* advanced functionality of this processor, please see the        *
;* demonstration applications, located in the examples             *
;* subdirectory of the "Freescale CodeWarrior for HC08" program    *
;* directory.                                                      *
;*******************************************************************

; Include derivative-specific definitions
            INCLUDE 'derivative.inc'

; export symbols
            XDEF _Startup, main
            ; we export both '_Startup' and 'main' as symbols. Either can
            ; be referenced in the linker .prm file or from C/C++ later on

            XREF __SEG_END_SSTACK   ; symbol defined by the linker for the end of the stack


; variable/data section
MY_ZEROPAGE: SECTION  SHORT         ; Insert here your data definition

INDEX       DS 1
T           DS 1
ONKAI       DS 1
MODE        DS 1
OTO         DS 1
; code section
MyCode:     SECTION
main:
_Startup:
            LDHX   #__SEG_END_SSTACK ; initialize the stack pointer
            TXS
            CLI                     ; enable interrupts

            LDA #00000000b     
            STA INDEX
            STA MODE
            STA OTO
            STA ONKAI
            STA T
            
            LDHX #0h
            
            LDA #00000000b       ;PTAを入力に
            STA PTADD        
            LDA #11111111b       ;PTBを出力に
            STA PTBDD
 
            BRA waitSw1On
            
;; タイマー --------------------            
ON_TIMER:      

           LDA #01000000b
           STA MTIMSC  
              
           LDX T
                    
           LDA ONPU, X 
           CMP #13
           BEQ Rest
           CMP #15
           BEQ MusicEnd
           STA ONKAI 
           BRA Next
Rest:
           LDA #00000000b    ;MTIM停止
           STA MTIMSC     
Next:           
           LDA NAGASA, X     ;音符の長さを設定
           ORA #01010000b    ;タイマ再設定
           STA SRTISC
           
           INC T
           BRA TimerEnd 
           
MusicEnd:
           LDA #00000000b
           STA MTIMSC
           LDA #01000000b   ; タイマoff
           STA SRTISC         
           LDA #0
           STA T
TimerEnd            
           RTI
;;-------------------------------
           
;; モジュロタイマー -------------             
ON_MTIM:
            feed_watchdog
            LDX ONKAI
            LDA DOREMI, X           ;2
            STA MTIMMOD          ;3

	          LDX INDEX            ;3
            LDA WAVEDATA, X      ;3
            STA PTBD             ;3
            INC INDEX
            LDA INDEX
            CMP #25
            BEQ goToFirst        ;3
            BRA MtimerEnd        ;3
goToFirst:
          
            LDA #0               ;2
            
MtimerEnd:  
            STA INDEX            ;3
            RTI                  ;9    40 * 24 + 34 = 994           
;;--------------------------------            
            
mainLoop:            
            feed_watchdog 
                      
waitSw1On:
            feed_watchdog                        
            LDA PTAD
            AND #00000001b
            BEQ waitSw1Off
            BRA waitSw1On

waitSw1Off:
            feed_watchdog
            LDA PTAD
            AND #00000001b
            BEQ waitSw1Off
            
            LDA #00010001b   ; タイマの設定
            STA SRTISC

            LDA #01000000b
            STA MTIMSC
            LDA #00000010b
            STA MTIMCLK
            LDA #11111111b
            STA MTIMMOD  
            
            LDA #00000000b
            STA T                  

            BRA    mainLoop



WAVEDATA: DC.B 80h,  9Fh,  0BDh, 0D7h, 0ECh
          DC.B 0F9H, 0FFH, 0FDH, 0F3H, 0E2H
          DC.B 0CBH, 0AFH, 90H,  6FH,  50H
          DC.B 34H,  1DH,  0CH,  02H,  00H
          DC.B 06H,  13H,  28H,  42H,  60H
          
DOREMI: DC.B 151, 143, 134, 123, 118, 111, 104, 98, 92, 86, 81, 76, 71, 0  

ONPU:   DC.B 13,  3, 13,  3,  1,  0,  3,  8, 10, 12, 13, 12, 13, 12, 10, 8, 13 
        DC.B  5, 13,  5, 13,  5,  7,  8,  7,  8,  5,  3 , 5,  3,  0, 3, 13
        DC.B  3, 13,  3,  1,  0,  3,  8, 10, 12, 13, 12, 13, 12, 10, 8, 13 
        DC.B 10, 13, 10, 13, 10, 13, 10,  8, 13,  8, 13,  7, 13,  7, 8, 13,  8, 13,  8, 13, 15
      
NAGASA: DC.B  6,  6,  1,  5,  5,  5,  5,  5,  5,  5,  1,  5,  1,  5,  5, 6, 6
        DC.B  5,  1,  5,  1,  5,  5,  5,  5,  5,  5,  5,  5,  5,  5,  6, 6
        DC.B  6,  1,  5,  5,  5,  5,  5,  5,  5,  1,  5,  1,  5,  5,  6, 6
        DC.B  5,  1,  5,  1,  5,  1,  5,  5,  1,  5,  1,  5,  1,  5,  6, 1,  6,  1,  6, 6

        

            ORG Vrti
            DC.W ON_TIMER
            
            ORG Vmtim
            DC.W ON_MTIM

