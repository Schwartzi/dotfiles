use "/Users/Ryosuke/pro-d/sml_kadai/lib.sml";

fun compute s mapL =
    let

        fun findValue s (nil : (string * int) list) = raise NotDefined
          | findValue s (h::t) =
            if #1 h = s then
                #2 h
            else
                findValue s t;
        
        fun EXP nil = raise SyntaxError
          | EXP (h::t) =
            let
                val (v1, t1) = TERM t
                val op       = hd t1
                val (v2, t2) = TERM(tl t1)
            in
                if op = "+" then
                    (v1 + v2, t2)
                else if op = "-" then
                    (v1 - v2, t2)
                else raise SyntaxError
            end
                
        and TERM nil = raise SyntaxError
          | TERM (h::t) =
            let 
                val (v1, t1) = BASE  t
                val op       = hd t1
                val (v2, t2) = BASE(tl t1)
            in
                if (op = "*") then
                (* B * B *)
                    (v1 * v2, t2)
                else if (h = "/") then
                (* B / B *)
                    (v1 / v2, t2)
                else raise SyntaxError

        and BASE nil = raise SyntaxError
          | BASE (h::t) =
            if isInt h then
                (toInt h, t)
            else if isAlp h then
                (findValue h mapL, t)
            else if h = "(" then
                EXP(t)
            else raise SyntaxError

    in
        let
            val (result,rest) = BASE (separate s)
        in
            if rest = nil then result
            else raise SyntaxError
        end
    end;




compute "( fibo  6 )" [("a", 1)];
