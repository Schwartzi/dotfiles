%%% icsreport.cls --- class for ICS report

%%% Copyright (C) 2000 KITAJIMA AKira.

%%% Author: KITAJIMA Akira <kitajima@ics.es.osaka-u.ac.jp>
%%% Create: Saturday, April 29, 2000

%%% $Id: icsreport.cls,v 1.3 2000/07/31 03:13:16 kitajima Exp $

\NeedsTeXFormat{pLaTeX2e}
\ProvidesClass{icsreport}[2000/7/31 Osaka Univ. ICS report class]

%%% ページ
\def\ps@draft{\let\@mkboth\@gobbletwo
   \let\ps@jpl@in\ps@draft
   \let\@oddhead\@empty
   \def\@oddfoot{\reset@font\hfil\thepage\quad 
     [\today \the\hour 時\the\minute 分]}%
   \let\@evenhead\@empty
   \let\@evenfoot\@oddfoot}
\pagestyle{plain}

\newif\ifnotitlepage\notitlepagefalse
\DeclareOption{notitlepage}{\notitlepagetrue}

\newif\ifdraftpage\draftpagefalse
\DeclareOption{draftpage}{\pagestyle{draft}\draftpagetrue}

\newif\ifsmallfont\smallfontfalse
\DeclareOption{9pt}{%\def\baselinestretch{1.21}
  \smallfonttrue
  \let\large=\normalsize
  \renewcommand{\normalsize}{%
  \@setfontsize\normalsize\@ixpt{11}%
  \abovedisplayskip 8.5\p@ \@plus3\p@ \@minus4\p@
  \abovedisplayshortskip \z@ \@plus2\p@
  \belowdisplayshortskip 4\p@ \@plus2\p@ \@minus2\p@
  \def\@listi{\leftmargin\leftmargini
              \topsep 4\p@ \@plus2\p@ \@minus2\p@
              \parsep 2\p@ \@plus\p@ \@minus\p@
              \itemsep \parsep}%
            \addtolength\baselineskip{2\p@}%
  \belowdisplayskip \abovedisplayskip}%
%  \let\normalsize=\small
  \let\small=\footnotesize
  \normalsize}
\DeclareOption*{\PassOptionsToClass{\CurrentOption}{jarticle}}
\ProcessOptions

\LoadClass[fleqn]{jarticle}
\西暦true

\def\baselinestretch{1.22}

%%% 大きさ・長さの調整
\oddsidemargin=-1in
\addtolength{\oddsidemargin}{3cm}
\topmargin=-1in
\addtolength{\topmargin}{2.7cm}
\addtolength{\topmargin}{-\headsep}
\addtolength{\topmargin}{-\headheight}
\ifdraftpage
  \footskip=5mm
\else
  \footskip=15mm
\fi
% a4 の高さ……297mm
\textheight=24cm
% a4 の幅……210mm
\textwidth=15.7cm
\columnsep=2zw
\raggedbottom
\parskip=\z@
\partopsep=\z@

\dbltextfloatsep=15pt
\textfloatsep=15pt

\abovecaptionskip=\z@
\belowcaptionskip=10pt

%% 数式モード
%\abovedisplayskip=\z@
%\belowdisplayskip=\z@
%\abovedisplayshortskip=\z@
%\belowdisplayshortskip=\z@
\topsep=\z@
\jot=\z@

%%% from ipsjpapers.sty
\def\ipsj@warning{\ClassWarning{ipsjreport}}                    % 2.00(3)

\newdimen\@mojihaba \@mojihaba=1zw

\newdimen\@Q \@Q=0.25mm

\newif\ifDS@english \DS@englishfalse

\let\fs@header\footnotesize
\let\fs@abst\small
\def\fs@eabst{\small\baselineskip13\@Q}
\let\fs@type\fn@fontxv
\let\fs@title\huge
\let\fs@author\Large
\let\fs@sec\large
\let\fs@subsec\normalsize
\let\fs@affil\large

\let\jintercharskip\kanjiskip
\let\jasciikanjiskip\xkanjiskip
\let\jmathkanjiskip\xkanjiskip
\newdimen\jspaceskip \jspaceskip1zw

%%% 報告書の情報マクロ

\def\@課題名{}
\newcommand{\課題名}[1]{\def\@課題名{#1}}
\def\@担当教官{}
\newcommand{\担当教官}[1]{\def\@担当教官{#1}}
\def\@所属{}
\newcommand{\所属}[1]{\def\@所属{#1}}
\def\@学年{}
\newcommand{\学年}[1]{\def\@学年{#1}}
\def\@学籍番号{}
\newcommand{\学籍番号}[1]{\def\@学籍番号{#1}}
\def\@班{\relax}
\newcommand{\班}[1]{\def\@班{#1}}
\def\@email{}
\newcommand{\email}[1]{\def\@email{#1}}

%%% 表紙

\renewcommand{\maketitle}{%
\ifnotitlepage
\newpage
\global\@topnum\z@   % Prevents figures from going at top of page.
\hfill{\small\@date 提出}%
\medskip

\qquad{\sffamily\bfseries\Large\@title}\quad
{\large ---\@課題名---}\qquad (\@担当教官 教官)%
\medskip

\hfill\@author\quad\@学籍番号\qquad\null
\vspace{-4pt}

{\small\hfill\@email\qquad\null}%
\vspace{-4pt}

{\small\hfill\@所属・\@学年
\settowidth\@tempdima{\@班}%
\ifdim\@tempdima>\z@%
  \quad\@班
\fi
\qquad\null}%
\bigskip
\par
\else % 表紙をつける
\begin{titlepage}
\vspace*{7cm}
\begin{center}
  {\fs@title \@title}\\
  \bigskip

  {\LARGE \@課題名}\\
  \medskip

  \large 【担当教官】\quad\@担当教官\quad 教官
\end{center}
\vspace*{9cm}
\begin{large}
\begin{tabbing}
マージン\hspace{6cm}\=  項目====\=  内容\kill
                      \> 【提出者】\> \@author \quad(\@学籍番号)\\
                      \>           \> \@所属・\@学年\\
\settowidth\@tempdima{\@班}\ifdim\@tempdima>\z@
                      \>           \> \@班\\
\fi
                      \>           \> \@email\\
                      \> 【提出日】\> \@date
\end{tabbing}
\end{large}
\end{titlepage}
\fi
}


%%% 時間(ページに使用)
%%% from time.sty by Sunando Sen <sens@nyuacf.bitnet> <sens@acfcluster.nyu.edu>
\newcount\hour
\newcount\minute
\hour=\time
\divide \hour by 60
\minute=\time
\count99=\hour \multiply \count99 by -60 \advance \minute by \count99

%%%%%% Font Size Macros %%%%%%

\def\fs@setsize#1#2#3#4{\normalsize\dimen@\normalbaselineskip
        \@ifstar{\@setsize{#1}{\dimen@}{#3}{#4}}%
                {\@setsize{#1}{#2}{#3}{#4}}}

% s = (4*b - (h' + d') - (h + d))/2
% s_a = s + h' + d - b
% s_b = s + h + d' - b
\def\sec@setskips#1{\setbox0\hbox{\fs@sec\bf#1}\setbox1\hbox{#1}
        \@tempdima4\baselineskip
        \advance\@tempdima-\ht0 \advance\@tempdima-\dp0
        \advance\@tempdima-\ht1 \advance\@tempdima-\dp1
        \divide\@tempdima\tw@ \advance\@tempdima-\baselineskip
        \@tempdimb\@tempdima
        \advance\@tempdima\ht0 \advance\@tempdima\dp1
        \advance\@tempdimb\ht1 \advance\@tempdimb\dp0
        \edef\sec@aboveskip{\the\@tempdima}
        \edef\sec@belowskip{\the\@tempdimb}}

\sec@setskips{A}

%%% from ipsjcommon.sty

%%%%%% Sectioning Commands %%%%%%

% \section:     2行取り
% others:       1行取り
%
% Note that \paragraph and \subparagraph act as \subsubsubsection and
% \subsubsubsubsection resp.
%
% The form of sectioning header is;
%       <1 Kanji sp> \the<sect-command> [`.' if \section] <1 Kanji sp> <title>
% Nothe that <1 Kanji sp> is that of \normalsize.

\def\section{\@startsection
        {section}{1}{\z@}{\sec@aboveskip}{1ex}{\fs@sec\bf}}
\def\subsection{\@startsection
        {subsection}{2}{\z@}{1ex}{0.5ex}{\fs@subsec\bf}}
\def\subsubsection{\@startsection
        {subsubsection}{3}{\@mojihaba}{\z@}{\z@}{\fs@subsec\bf}}
\def\paragraph{\@startsection
        {paragraph}{4}{\z@}{\z@}{-\@mojihaba}{\fs@subsec\bf}}
\def\subparagraph{\@startsection
        {subparagraph}{5}{\@mojihaba}{\z@}{-\@mojihaba}{\fs@subsec\bf}}

\def\thesection{\arabic{section}}
\def\sec@section@postfix{.}
\def\thesubsection{\thesection.\arabic{subsection}}
\def\thesubsubsection{\thesubsection.\arabic{subsubsection}}
\def\theparagraph{\thesubsubsection.\arabic{paragraph}}
\def\thesubparagraph{\theparagraph.\arabic{subparagraph}}

\setcounter{secnumdepth}{5}

\def\appendix{\let\sec@sec\section
        \def\section{\@startsection
                {section}{1}{\z@}{\sec@aboveskip}{1ex}{\fs@subsec\bf}}%
        \def\thesection{\appendixprefix\arabic{section}}%
        \def\sec@section@postfix{\appendixpostfix}%
        \stepcounter{section}\setcounter{section}{0}%
        \@ifnextchar[%]
                     {\sec@oappendix}{\sec@xappendix}}
\def\sec@xappendix{\@ifstar{\let\section\sec@sec}%
        {\sec@sec*{\ifDS@english Appendix\else 付録\fi}}}
\def\sec@oappendix[#1]{\sec@sec*{\ifDS@english Appendix: \else
        付録\hskip\jspaceskip\fi #1}}
\def\appendixprefix{A.}
\def\appendixpostfix{}

\def\acknowledgment{\par
        {\bf \ifDS@english Acknowledgments\else 謝辞\fi}\hskip\@mojihaba
        \ignorespaces}
\let\endacknowledgment\par

% Modified \@startsection has a trick for 2行取り of \section, which must
% work even if \section appears the top of a page.  The BEFORESKIP must be
% inserted with respect to the previous baseline.  So, we must go back to
% the imaginary previous baseline at the top of a page.  That is, we do;
%       \vskip\baselineskip \vspace*{-\baselineskip}
% which resuls;
%       <a> do nothing at midpage
%       <b> go to the first baseline by \topskip, then go back to 0th
%           baseline by \vspace*.
% The trick "\vskip-\prevdepth \prevdepth\z@" will assure exact vertical
% space even when the last line has much depth.
%
% \@startsection {NAME}{LEVEL}{INDENT}{BEFORESKIP}{AFTERSKIP}{STYLE}
\def\@startsection#1#2#3#4#5#6{\if@noskipsec \leavevmode \fi
        \par \@tempskipa #4\relax
        \@afterindenttrue
        \ifdim\@tempskipa<\z@ \@tempskipa-\@tempskipa \@afterindentfalse\fi
        \if@nobreak \everypar{}\else \addpenalty{\@secpenalty}\fi
        \ifdim\@tempskipa>\z@
% Here is the trick for \section.
                \vskip-\prevdepth \prevdepth\z@ \vskip\baselineskip
                \vspace*{-\baselineskip}\vskip\@tempskipa\fi
        \@ifstar
        {\@ssect{#3}{#4}{#5}{#6}}{\@dblarg{\@sect{#1}{#2}{#3}{#4}{#5}{#6}}}}

% \@sect is modified to cope with `.' for \section and 文字取り
%
% \@sect{NAME}{LEVEL}{INDENT}{BEFORESKIP}{AFTERSKIP}{STYLE}[TITLE]{TITLE}
\def\@sect#1#2#3#4#5#6[#7]#8{\ifnum #2>\c@secnumdepth
        \def\@svsec{}\else 
        \refstepcounter{#1}
                                                                % 2.00(1)>>
        \let\@@protect\protect \def\protect{\noexpand\protect\noexpand}
        \edef\@svsec{\csname the#1\endcsname \csname sec@#1@postfix\endcsname
                \hskip\@mojihaba} \let\protect\@@protect\fi     % 2.00(1)<<
        \@tempskipa #5\relax
        \ifdim \@tempskipa<\z@ 
                \def\@svsechd{#6\hskip #3\relax%\@svsec
 #8}      % 2.00(1)
        \else
                \begingroup #6\relax
                \@hangfrom{\hskip #3\relax\@svsec}%
                        {\interlinepenalty\@M \sec@mojidori{#8}\par}%
                \endgroup
        \fi \@xsect{#5}}

% \@ssect is modified to cope with 文字取り
%
% \@sect{INDENT}{BEFORESKIP}{AFTERSKIP}{STYLE}{TITLE}
\def\@ssect#1#2#3#4#5{\@tempskipa #3\relax
        \ifdim \@tempskipa<\z@ \def\@svsechd{#4\hskip #1\relax #5}%
        \else \begingroup #4%
                \@hangfrom{\hskip #1}{\interlinepenalty\@M
                        \sec@mojidori{#5}\par}\endgroup
        \fi \@xsect{#3}}

%% Modify \@xsect to avoid (buggy) \clubpenalty=10000. (H.N.)
\def\@xsect#1{\@tempskipa #1\relax
        \ifdim \@tempskipa<\z@
                \global\@nobreakfalse \global\@noskipsectrue
                \everypar{\global\@noskipsecfalse \hskip-\parindent
                        \begingroup \@svsechd \endgroup \unskip
                        \hskip -#1\everypar{}}%
        \else
                \par \nobreak
                \vskip \@tempskipa \global\@nobreaktrue
                \everypar{\global\@nobreakfalse
                        \if@afterindent\else {\setbox0\lastbox}\fi \everypar{}}
        \fi\ignorespaces}

% Here is a trick for 文字取り of sectioning tilte.  The rule is;
%       2 - 4 Kanji char -> 5 Kanji char
%       otherwise    -> natural width
%
\def\sec@mojidori#1{\setbox0\hbox{#1}\settowidth\@tempdimb{あ}%
        \ifdim\wd0>4.5\@tempdimb #1\else
        \ifdim\wd0<1.5\@tempdimb #1\else
        \jintercharskip\fill \jasciikanjiskip\fill \jmathkanjiskip\fill
        \leavevmode\hbox to5\@tempdimb{#1\hfil}\fi\fi}

%%%%%% List-like Environments %%%%%%
%
%               LM      RM      LW      LS      LPI     II
% default       2K      0       0.75K   0.25K   0       0
% \enumerate    3K      0       3K      0       0       0
% \enumerate*   1K      0       3K      0       0       2K
% \itemize      2K      0       2K      0       0       0
% \itemize*     1K      0       2K      0       0       1K
% \description  2K      0       0       1K      0       -1K
% \description* 1K      0       0       1K      0       0
% \verse        3K      2K      0.75K   0.25K   -1K     -1K
% \quotation    2K      2K      0.75K   0.25K   1K      1K
% \quote        2K      2K      0.75K   0.25K   0       0
%
% where LM is \leftmargin, RM is \rightmargin, LW is \labelwidth, LS is
% \labelsep, \LPI is \listparindent, II is \itemindent, and K is Kanji char
% width (\@mojihaba).
%
% All vertical space parameters, \topsep, \partopsep, \itemsep and \parsep,
% are 0pt.

\leftmargini2\@mojihaba
\leftmarginii2\@mojihaba
\leftmarginiii2\@mojihaba
\leftmarginiv2\@mojihaba
\leftmarginv2\@mojihaba
\leftmarginvi2\@mojihaba

\def\lst@listi{\labelsep.75\@mojihaba \labelwidth.25\@mojihaba
        \rightmargin\z@ \listparindent\z@ \itemindent\z@
        \partopsep\z@ \parsep\z@ \topsep\z@ \itemsep\z@}
\def\@listi{\leftmargin\leftmargini \lst@listi}
\def\@listii{\leftmargin\leftmarginii \lst@listi}
\def\@listiii{\leftmargin\leftmarginiii \lst@listi}
\def\@listiv{\leftmargin\leftmarginiv \lst@listi}
\def\@listv{\leftmargin\leftmarginv \lst@listi}
\def\@listvi{\leftmargin\leftmarginvi \lst@listi}

\@listi

\def\labelenumi{\theenumi.} 
\def\theenumi{\arabic{enumi}} 
\def\labelenumii{\theenumii.}
\def\theenumii{\alph{enumii}}
\def\p@enumii{\theenumi}
\def\labelenumiii{\theenumiii.}
\def\theenumiii{\roman{enumiii}}
\def\p@enumiii{\theenumi(\theenumii)}
\def\labelenumiv{(\,\theenumiv\,)}
\def\theenumiv{\Alph{enumiv}}
\def\p@enumiv{\p@enumiii\theenumiii}
\def\enumerate{\ifnum \@enumdepth >3 \@toodeep\else
        \advance\@enumdepth \@ne 
        \edef\@enumctr{enum\romannumeral\the\@enumdepth}
        \list{\csname label\@enumctr\endcsname}{\usecounter
                {\@enumctr}\def\makelabel##1{##1\hss}%
                \ifnum \@listdepth =\@ne \leftmargin1zw\relax
                \else\leftmargin\leftskip\fi
                \advance\leftmargin 2zw
                \labelwidth1.7\@mojihaba \labelsep\z@%
                \itemsep=\z@\parsep=\z@\topsep=\z@}\fi}
\let\endenumerate\endlist

\def\labelitemi{$\bullet$}
\def\labelitemii{\bf --}
\def\labelitemiii{\rule[0.3ex]{3pt}{3pt}}
\def\labelitemiv{$\cdot$}
\def\itemize{\ifnum \@itemdepth >3 \@toodeep\else \advance\@itemdepth \@ne
        \edef\@itemitem{labelitem\romannumeral\the\@itemdepth}%
        \list{\csname\@itemitem\endcsname}{\def\makelabel##1{\hss##1\hss}%
                \ifnum \@listdepth =\@ne \leftmargin1zw\relax
                \else\leftmargin\leftskip\fi
                \advance\leftmargin 2zw
                \labelwidth2\@mojihaba \labelsep\z@%
                \itemsep=\z@\parsep=\z@\topsep=\z@}\fi}
\let\enditemize\endlist

\def\description{\list{}{\labelwidth\z@ \labelsep\@mojihaba
        \itemindent\labelsep \advance\itemindent-\leftmargin
        \def\makelabel##1{\bf ##1}}}
\let\enddescription\endlist

\let\latex@trivlist\@trivlist
\def\lst@trivlist#1#2{\leftmargin#1\relax
        \itemindent\labelwidth \advance\itemindent\labelsep
        \advance\itemindent#2\relax
        \let\@trivlist\latex@trivlist \@trivlist}

\def\lst@strivlist{\def\@trivlist{\lst@trivlist\@mojihaba{-\@mojihaba}}}
\@namedef{enumerate*}{\lst@strivlist \enumerate}
\@namedef{endenumerate*}{\endlist}
\@namedef{itemize*}{\lst@strivlist \itemize}
\@namedef{enditemize*}{\endlist}
\@namedef{description*}{\lst@strivlist \description}
\@namedef{enddescription*}{\endlist}

\def\verse{\let\\=\@centercr 
        \list{}{\itemindent-\@mojihaba \listparindent\itemindent 
        \rightmargin\leftmargin \advance\leftmargin\@mojihaba}\item[]}
\let\endverse\endlist
\def\quotation{\list{}{\listparindent\@mojihaba \itemindent\listparindent
        \rightmargin\leftmargin}\item[]}
\let\endquotation\endlist
\def\quote{\list{}{\rightmargin\leftmargin}\item[]}
\let\endquote\endlist

\def\newtheorem{\@ifstar
        {\theo@newtheorem{\theo@it}{\ }}{\theo@newtheorem{}{\theo@sp}}}
\def\theo@newtheorem#1#2#3{\@namedef{theo@it@#3}{#1}\@namedef{theo@sp@#3}{#2}%
        \@ifnextchar[%]
                     {\@othm{#3}}{\@nthm{#3}}}
\def\@begintheorem#1#2{\DESCRIPTION \csname theo@it@\@currenvir\endcsname
        \item[#1\csname theo@sp@\@currenvir\endcsname #2]}
\def\@opargbegintheorem#1#2#3{\DESCRIPTION
        \csname theo@style@\@currenvir\endcsname
        \item[#1\csname theo@sp@\@currenvir\endcsname #2\ (#3)]}
\let\@endtheorem\endlist                                        % 1.02(2)
\ifDS@english
\let\theo@it\it \let\theo@sp\ %
\else
\let\theo@it\relax \let\theo@sp\relax
\fi


%%% キャプション

\long\def\@makecaption#1#2{%
  \vskip\abovecaptionskip
  \iftdir\sbox\@tempboxa{#1\hskip1zw#2}%
    \else\sbox\@tempboxa{\gt\sffamily\small#1\quad#2}%
  \fi
  \ifdim \wd\@tempboxa >\hsize
    \iftdir #1\hskip1zw#2\relax\par
      \else {\gt\sffamily\small#1\quad#2}\relax\par\fi
  \else
    \global \@minipagefalse
    \hbox to\hsize{\hfil\box\@tempboxa\hfil}%
  \fi
  \vskip\belowcaptionskip}

%%% 環境

\let\origverbatim\verbatim
\def\verbatim{\begingroup\par\baselineskip=1.3zh\medskip\origverbatim}

\let\origendverbatim\endverbatim
\def\endverbatim{\origendverbatim\endgroup}

%%% 文献引用
%%% from ieicej.sty Version 1.1 [2 August 1995]

%% from "citesort.sty", with a little modified
\newcount\@minsofar
\newcount\@min
\newcount\@cite@temp
\def\@citex[#1]#2{%
\if@filesw \immediate \write \@auxout {\string \citation {#2}}\fi
\@tempcntb\m@ne \let\@h@ld\relax \def\@citea{}%
\@min\m@ne%
\@cite{%
  \@for \@citeb:=#2\do {\@ifundefined {b@\@citeb}%
    {\@h@ld\@citea\@tempcntb\m@ne{\bf ?}%
    \@warning {Citation `\@citeb ' on page \thepage \space undefined}}%
{\@minsofar\z@ \@for \@scan@cites:=#2\do {%
  \@ifundefined{b@\@scan@cites}%
    {\@cite@temp\m@ne}
    {\@cite@temp\number\csname b@\@scan@cites \endcsname \relax}%
\ifnum\@cite@temp > \@min% select the next one to list
    \ifnum\@minsofar = \z@
      \@minsofar\number\@cite@temp
      \edef\@scan@copy{\@scan@cites}\else
    \ifnum\@cite@temp < \@minsofar
      \@minsofar\number\@cite@temp
      \edef\@scan@copy{\@scan@cites}\fi\fi\fi}\@tempcnta\@min
  \ifnum\@minsofar > \z@ % some more
    \advance\@tempcnta\@ne
    \@min\@minsofar
    \ifnum\@tempcnta=\@minsofar %   Number follows previous--hold on to it
      \ifx\@h@ld\relax
        \edef \@h@ld{\@citea\csname b@\@scan@copy\endcsname}%
      \else \edef\@h@ld{\ifmmode{]〜[}\else]〜[\fi\csname b@\@scan@copy\endcsname}%
      \fi
    \else \@h@ld\@citea\csname b@\@scan@copy\endcsname
          \let\@h@ld\relax
  \fi % no more
\fi}%
\def\@citea{],\penalty\@highpenalty\,[}}\@h@ld}{#1}}
%% end of citesort.sty

\def\@cite#1#2{\leavevmode\unskip
  \ifnum\lastpenalty=\z@\penalty\@highpenalty\fi% highpenalty before
  \,[{\multiply\@highpenalty 3 #1%             % triple-highpenalties within
      \if@tempswa,\penalty\@highpenalty\ #2\fi % and before note.
    }]\spacefactor\@m}

%%% icsreport.cls ends here
