;*******************************************************************
;* This stationery serves as the framework for a user application. *
;* For a more comprehensive program that demonstrates the more     *
;* advanced functionality of this processor, please see the        *
;* demonstration applications, located in the examples             *
;* subdirectory of the "Freescale CodeWarrior for HC08" program    *
;* directory.                                                      *
;*******************************************************************

; Include derivative-specific definitions
            INCLUDE 'derivative.inc'

; export symbols
            XDEF _Startup, main
            ; we export both '_Startup' and 'main' as symbols. Either can
            ; be referenced in the linker .prm file or from C/C++ later on

            XREF __SEG_END_SSTACK   ; symbol defined by the linker for the end of the stack


; variable/data section
MY_ZEROPAGE: SECTION  SHORT         ; Insert here your data definition

INDEX       DS 1
T           DS 1
ONKAI       DS 1
MODE        DS 1
OTO         DS 1
; code section
MyCode:     SECTION
main:
_Startup:
            LDHX   #__SEG_END_SSTACK ; initialize the stack pointer
            TXS
            CLI                     ; enable interrupts

            LDA #00000000b
            STA INDEX
            STA MODE
            STA OTO
            STA ONKAI
            STA T
            
            LDHX #0h
            
            LDA #00000000b       ;PTAを入力に
            STA PTADD        
            LDA #11111111b       ;PTBを出力に
            STA PTBDD

            LDA #00010001b   ; タイマの設定
            STA SRTISC

            LDA #01000000b
            STA MTIMSC
            LDA #00000010b
            STA MTIMCLK
            LDA #11111111b
            STA MTIMMOD
            

            
            BRA mainLoop
            
ON_TIMER:         
           LDX T
           
           LDA ONPU, X 
           STA ONKAI 
           
           LDA NAGASA, X
           ORA #01010000b     ;タイマ再設定
           STA SRTISC
           
           INC T          
            
           RTI
            
ON_MTIM:
            feed_watchdog
            LDX ONKAI
            LDA DOREMI, X           ;2
            STA MTIMMOD          ;3

	          LDX INDEX            ;3
            LDA WAVEDATA, X      ;3
            STA PTBD             ;3
            INC INDEX
            LDA INDEX
            CMP #25
            BEQ goToFirst        ;3
            BRA MtimerEnd        ;3
goToFirst:
          
            LDA #0               ;2
            
MtimerEnd:  
            STA INDEX            ;3
            RTI                  ;9    40 * 24 + 34 = 994

            
mainLoop:            
            feed_watchdog


            BRA    mainLoop



WAVEDATA: DC.B 80h,  9Fh,  0BDh, 0D7h, 0ECh
          DC.B 0F9H, 0FFH, 0FDH, 0F3H, 0E2H
          DC.B 0CBH, 0AFH, 90H,  6FH,  50H
          DC.B 34H,  1DH,  0CH,  02H,  00H
          DC.B 06H,  13H,  28H,  42H,  60H
          
DOREMI: DC.B 143, 134, 123, 118, 111, 104, 98, 92, 86, 81, 76, 71    

ONPU:   DC.B 0, 2, 4, 5, 4, 2, 0 
        DC.B 4, 5, 7, 9, 7, 5, 4 
        DC.B 0, 0, 0, 0 
        DC.B 0, 0, 2, 2, 4, 4, 5, 5
        DC.B 4, 2, 0, 10
      
NAGASA: DC.B 5, 5, 5, 5, 5, 5, 6
        DC.B 5, 5, 5, 5, 5, 5, 6
        DC.B 6, 6, 6, 6
        DC.B 4, 4, 4, 4, 4, 4, 4, 4
        DC.B 5, 5, 5
        

            ORG Vrti
            DC.W ON_TIMER
            
            ORG Vmtim
            DC.W ON_MTIM

